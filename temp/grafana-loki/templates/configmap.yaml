{{- $preset := include "postgresql-pod.preset" . | fromYaml -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgresql-pod.fullname" . }}-config
  namespace: {{ include "postgresql-pod.namespace" . }}
  labels:
    {{- include "postgresql-pod.labels" . | nindent 4 }}
data:
  # PostgreSQL configuration
  postgresql.conf: |
    # PostgreSQL Configuration - Fireball Industries Edition
    # Auto-generated by Helm chart (because manual config is for masochists)
    # Preset: {{ .Values.resourcePreset }}
    
    # Connection Settings
    {{ include "postgresql-pod.postgresqlConfig" . | nindent 4 }}
    superuser_reserved_connections = {{ .Values.postgresql.config.superuser_reserved_connections }}
    
    # WAL Settings
    wal_level = {{ .Values.postgresql.config.wal_level }}
    max_wal_senders = {{ .Values.postgresql.config.max_wal_senders }}
    max_replication_slots = {{ .Values.postgresql.config.max_replication_slots }}
    wal_keep_size = {{ .Values.postgresql.config.wal_keep_size }}
    
    # Checkpoints
    checkpoint_timeout = {{ .Values.postgresql.config.checkpoint_timeout }}
    checkpoint_completion_target = {{ .Values.postgresql.config.checkpoint_completion_target }}
    max_wal_size = {{ .Values.postgresql.config.max_wal_size }}
    min_wal_size = {{ .Values.postgresql.config.min_wal_size }}
    
    # Query Planner
    random_page_cost = {{ .Values.postgresql.config.random_page_cost }}
    effective_io_concurrency = {{ .Values.postgresql.config.effective_io_concurrency }}
    
    # Logging (Patrick's debugging essentials)
    logging_collector = {{ .Values.postgresql.config.logging_collector }}
    log_destination = {{ .Values.postgresql.config.log_destination }}
    log_line_prefix = '{{ .Values.postgresql.config.log_line_prefix }}'
    log_statement = {{ .Values.postgresql.config.log_statement }}
    log_duration = {{ .Values.postgresql.config.log_duration }}
    log_min_duration_statement = {{ .Values.postgresql.config.log_min_duration_statement }}
    log_checkpoints = {{ .Values.postgresql.config.log_checkpoints }}
    log_connections = {{ .Values.postgresql.config.log_connections }}
    log_disconnections = {{ .Values.postgresql.config.log_disconnections }}
    log_lock_waits = {{ .Values.postgresql.config.log_lock_waits }}
    
    # Autovacuum
    autovacuum = {{ .Values.postgresql.config.autovacuum }}
    autovacuum_max_workers = {{ .Values.postgresql.config.autovacuum_max_workers }}
    autovacuum_naptime = {{ .Values.postgresql.config.autovacuum_naptime }}
    
    # Locale
    timezone = {{ .Values.postgresql.config.timezone }}
    lc_messages = {{ .Values.postgresql.config.lc_messages }}
    lc_monetary = {{ .Values.postgresql.config.lc_monetary }}
    lc_numeric = {{ .Values.postgresql.config.lc_numeric }}
    lc_time = {{ .Values.postgresql.config.lc_time }}
    
    {{- if .Values.postgresql.extensions.pgStatStatements.enabled }}
    # pg_stat_statements
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.max = {{ .Values.postgresql.extensions.pgStatStatements.max }}
    pg_stat_statements.track = {{ .Values.postgresql.extensions.pgStatStatements.track }}
    {{- end }}
    
    {{- if eq (include "postgresql-pod.isHA" .) "true" }}
    # High Availability
    hot_standby = on
    {{- if .Values.highAvailability.replication.synchronous }}
    synchronous_commit = {{ .Values.highAvailability.replication.synchronousCommit }}
    synchronous_standby_names = 'FIRST {{ .Values.highAvailability.replication.numSynchronousReplicas }} (*)'
    {{- end }}
    {{- end }}
    
    {{- if .Values.security.tls.enabled }}
    # TLS/SSL
    ssl = on
    ssl_cert_file = '/etc/postgresql/certs/{{ .Values.security.tls.certFile }}'
    ssl_key_file = '/etc/postgresql/certs/{{ .Values.security.tls.certKeyFile }}'
    ssl_ca_file = '/etc/postgresql/certs/{{ .Values.security.tls.caFile }}'
    {{- end }}
    
    {{- range $key, $value := .Values.customPostgresqlConf }}
    {{ $key }} = {{ $value }}
    {{- end }}
  
  # pg_hba.conf - Client authentication configuration
  pg_hba.conf: |
    # PostgreSQL Client Authentication Configuration
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # "local" is for Unix domain socket connections only
    {{- if .Values.postgresql.auth.trustLocal }}
    local   all             all                                     trust
    {{- else }}
    local   all             all                                     {{ .Values.postgresql.auth.authMethod }}
    {{- end }}
    
    # IPv4 local connections
    host    all             all             127.0.0.1/32            {{ .Values.postgresql.auth.authMethod }}
    
    # IPv6 local connections
    host    all             all             ::1/128                 {{ .Values.postgresql.auth.authMethod }}
    
    # Allow replication connections from localhost
    {{- if eq (include "postgresql-pod.isHA" .) "true" }}
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            trust
    host    replication     all             ::1/128                 trust
    
    # Allow replication from replicas (pod network)
    host    replication     {{ .Values.highAvailability.replication.username }}    0.0.0.0/0    {{ .Values.postgresql.auth.authMethod }}
    {{- end }}
    
    # Allow connections from pod network
    host    all             all             0.0.0.0/0               {{ .Values.postgresql.auth.authMethod }}
    host    all             all             ::/0                    {{ .Values.postgresql.auth.authMethod }}
    
    {{- range .Values.customPgHba }}
    {{ . }}
    {{- end }}

---
{{- if .Values.postgresql.initScripts.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgresql-pod.fullname" . }}-init-scripts
  namespace: {{ include "postgresql-pod.namespace" . }}
  labels:
    {{- include "postgresql-pod.labels" . | nindent 4 }}
data:
  {{- range $name, $script := .Values.postgresql.initScripts.scripts }}
  {{ $name }}: |
    {{- $script | nindent 4 }}
  {{- end }}
  
  # Create initial databases
  00-create-databases.sql: |
    -- Create initial databases for Fireball Industries
    -- Because organizing your data is the first step to industrial enlightenment
    
    {{- range .Values.postgresql.initialDatabases }}
    CREATE DATABASE {{ .name }}
      WITH OWNER = {{ .owner }}
      ENCODING = '{{ .encoding }}'
      LC_COLLATE = '{{ .locale }}'
      LC_CTYPE = '{{ .locale }}'
      TEMPLATE = template0;
    {{- end }}
    
    -- Grant necessary permissions
    {{- range .Values.postgresql.initialDatabases }}
    GRANT ALL PRIVILEGES ON DATABASE {{ .name }} TO {{ .owner }};
    {{- end }}
{{- end }}
